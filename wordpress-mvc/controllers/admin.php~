<?php
class Admin extends Sistema{
	var $data;
	var $topPage = 'catmvc';
	var $access_level= 6;
	
	public function __construct(){
		parent::__construct();
		$this->data['title'] = 'Catalogo de Pantallas';
		$this->data['menu_title'] = 'Catalogo';
		$this->cat = $this->loadModel('Mod_categorias');
		$this->prod = $this->loadModel('Mod_productos');
		
	}
	function add_menu(){		
		if($_GET['page']!= 'jsu-opt' && isset($_GET['page'])) add_action('wp_head',$this->head());
		add_menu_page($this->data['title'],$this->data['menu_title'],$this->access_level,$this->topPage,array ( $this , 'principal'),$this->urlBase.'/theme/img/pantalla.png');
		add_submenu_page($this->topPage,'Categorias','Categorias',$this->access_level,'categorias',array ( $this , 'categorias'));
		add_submenu_page($this->topPage,'Productos','Productos',$this->access_level,'productos',array ( $this , 'productos'));
		add_submenu_page($this->topPage,'Imagenes','Subir Imagenes',$this->access_level,'imagenes',array ( $this , 'imagenes'));
		add_submenu_page($this->topPage,'','',$this->access_level,'cat-add',array ( $this , 'catadd'));
		add_submenu_page($this->topPage,'','',$this->access_level,'cat-mod',array ( $this , 'catmod'));		
		add_submenu_page($this->topPage,'','',$this->access_level,'images',array ( $this , 'imagenes'));
	 	add_management_page('', '', 0, 'del-cat', array ( $this , 'delCat'));
	 	add_management_page('', '', 0, 'prod-save', array ( $this , 'prodSave'));
	 	add_management_page('', '', 0, 'jsu-head', array ( $this , 'jsuHead'));
	}
	function principal(){
		$basename= split('/', plugin_basename(__FILE__));
		echo WP_PLUGIN_URL.'/'.$basename[0]. ' WP_PLUGIN_URL<br/>';
		echo plugin_basename(__FILE__). ' plugin_basename(__FILE__)<br/>';
	}
	function delCat(){
		if($_POST['confirma'] == ''){
			$this->view('cat/cat-conf');    			
		}else{
			$this->cat->elimina();
			$this->categorias();
		}
		
	}
	function categorias(){
		$mod = parent::loadModel('Mod_categorias');
		$this->view('cat/cat-add');
		$this->verCategorias($mod);
	}
	function productos(){
		$this->data['desc']= '';
		$this->data['categorias']= $this->cat->listaCat();
		$this->action= 'prod-save';
		$this->view('prod/prod-add',$this->data);
	}
	function prodSave(){
		$this->prod->insProd();
	}
	function catadd(){
		$mod = parent::loadModel('Mod_categorias');
		$mod->crear();
		$this->verCategorias($mod);
	}
	function catmod(){
		$mod = parent::loadModel('Mod_categorias');
		$mod->modifica();
		$this->verCategorias($mod);
	}
	function verCategorias($mod){
		$this->data['categorias']= $mod->listaCat();
		parent::view('cat/cat-add',$this->data);
		parent::view('cat/cat-view',$this->data);	
	}
	function imagenes(){
		if(count($_FILES['imagen'])) $this->uploadImg();
		$this->data['categorias']= '';
		$this->data['categorias']= $this->cat->listaCat();
		parent::view('sis/uploaderForm',$this->data);
	}	
	function uploadImg(){
		if($_FILES['imagen']['type']=='image/jpeg' && !$_FILES['imagen']['error']){			
			$mi = $this->loadModel('Mod_images');
			$name = $mi->imageName($_FILES['imagen']['name']);
			$destino= PATH_CM.'/uploads/img/'.$name;
			$thumbs=	PATH_CM.'/uploads/img/thumbs/'.$name;
			if(move_uploaded_file($_FILES['imagen']['tmp_name'], $destino)){
				$mi->insImage($name);
				chmod($destino, 0777);
				$thumb = $this->loadLibray('Thumb');
				$thumb->loadImage($destino); 
				$thumb->resize(100, 'width'); 
				$thumb->save($thumbs);				
			}else{
				echo '<h2>error al mover archivo</h2><p>revise los permisos de la carpeta '.$destino.'</p>';
			} 
		}
	}
}
?>